# 6. メッセージエンコーディング
Bluetooth Smartなどの多くのトランスポート層の通信は帯域幅制限があり、環境によってはJSONなどのシリアライゼーションフォーマットでは重すぎることがあります。このため、簡潔なバイナリエンコードができるCBOR(RFC7049)がエンコーディングに使われます。

メッセージの複雑さとパース及びバリデーションで必要なリソースを削減するため、すべてのメッセージは以下に示すCTAP2 canonical CBOR encodingを使う必要があります(MUST)。これはRFC7049の3.9章で定義されているCTAP2 canonical CBOR encoding formの正規化提案とは別物です。全てのエンコーダは重複キーがないようにCTAP2 canonical encoding formの中でCBORをシリアライズする必要があります(MUST)。全てのデコーダはCTAP2 canonical CBOR encoding formに適格でないCBORを弾くべき(SHOULD)であり、また重複キーを持ったメッセージも弾くべきです(SHOULD)。

CTAP2 canonical CBOR encoding formは以下のルールに従います:
* 整数はできるだけ小さくエンコードされる必要があります:
    * 0から23及び-1から-24はメジャーな型において同じバイトで表現されます
    * 24から255及び-25から-256はuint8_tで表現されなければいけません
    * 256から65535及び-257から-65536はuint16_tで表現されなければいけません
    * 65536から49672957295及び-65537から-49672957296はuint32_tで表現されなければいけません
* 浮動小数点表現の値に関しては、特段の変更を行いません
* 2から5のメジャーな型の長さの表現はできるだけ小さい必要があります。長さは、上記整数のルールに従います
* 長さが決まっていないアイテムに関しては、長さを確定させる必要があります
* マップのキーは昇順にソートされている必要があります。ソートのルール:
    * もし型が異なる場合、数値的に小さい値が先になります
    * もし二つのキーが違う長さを持っている場合、短いほうが先になります
    * もし二つのキーが同じ長さの場合は、字句のバイト単位で辞書順になります

    Note: これらのルールはメジャーな型0から3及び7(整数、文字列、単純な値)を正規エンコードするときの辞書順の比較と同じです。メジャーな型4から6(配列、マップ、タグ)に関しては異なり、CTAP2ではマップをキーとして扱いません。これらのルールはCTAP2が複雑なメジャー型をキーとして扱い始めた場合再検討する必要がある事項です。

* RFC7049の2.4章で示されるタグは、存在してはいけません(MUST NOT)
