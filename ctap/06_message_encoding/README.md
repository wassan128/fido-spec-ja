# 6. メッセージエンコーディング
Bluetooth Smartなどの多くのトランスポート層の通信は帯域幅制限があり、環境によってはJSONなどのシリアライゼーションフォーマットでは重すぎることがあります。このため、簡潔なバイナリエンコードができるCBOR(RFC7049)がエンコーディングに使われます。

メッセージの複雑さとパース及びバリデーションで必要なリソースを削減するため、すべてのメッセージは以下に示すCTAP2 canonical CBOR encodingを使う必要があります(MUST)。これはRFC7049の3.9章で定義されているCTAP2 canonical CBOR encoding formの正規化提案とは別物です。全てのエンコーダは重複キーがないようにCTAP2 canonical encoding formの中でCBORをシリアライズする必要があります(MUST)。全てのデコーダはCTAP2 canonical CBOR encoding formに適格でないCBORを弾くべき(SHOULD)であり、また重複キーを持ったメッセージも弾くべきです(SHOULD)。

CTAP2 canonical CBOR encoding formは以下のルールに従います:
* 整数はできるだけ小さくエンコードされる必要があります:
    * 0から23及び-1から-24はメジャーな型において同じバイトで表現されます
    * 24から255及び-25から-256はuint8_tで表現されなければいけません
    * 256から65535及び-257から-65536はuint16_tで表現されなければいけません
    * 65536から49672957295及び-65537から-49672957296はuint32_tで表現されなければいけません
* 浮動小数点表現の値に関しては、特段の変更を行いません
* 2から5のメジャーな型の長さの表現はできるだけ小さい必要があります。長さは、上記整数のルールに従います
* 長さが決まっていないアイテムに関しては、長さを確定させる必要があります
* マップのキーは昇順にソートされている必要があります。ソートのルール:
    * もし型が異なる場合、数値的に小さい値が先になります
    * もし二つのキーが違う長さを持っている場合、短いほうが先になります
    * もし二つのキーが同じ長さの場合は、字句のバイト単位で辞書順になります

    Note: これらのルールはメジャーな型0から3及び7(整数、文字列、単純な値)を正規エンコードするときの辞書順の比較と同じです。メジャーな型4から6(配列、マップ、タグ)に関しては異なり、CTAP2ではマップをキーとして扱いません。これらのルールはCTAP2が複雑なメジャー型をキーとして扱い始めた場合再検討する必要がある事項です。

* RFC7049の2.4章で示されるタグは、存在してはいけません(MUST NOT)

認証器によっては使用可能なメモリ容量が小さいことが考えられるため、CBOR構造の最大ネスト数は全てのメッセージエンコーディングにおいて、CBORマップやCBOR配列を組み合わた4とします。認証器はCBORのネストを最低でも4は許容する必要があります(MUST)。クライアント、プラットフォーム、サーバーは4以上のCBORネストを使ってはいけません(MUST NOT)。

同様に、認証器のメモリ制約のために、認証器はサポートするメッセージサイズに制限を設けても構いません(MAY)。デフォルトでは認証器は少なくとも1024バイトのメッセージをサポートしなければなりません(MUST)。認証器はauthenticatorGetInfoのレスポンスに含まれる、maxMsgSizeを用いてデフォルト以外のメッセージサイズを宣言することができます(MAY)。クライアント、プラットフォーム、サーバーは認証器がmaxMsgSizeで1024バイト以上の値を指定していない場合、それ以上のサイズのメッセージを送ってはいけません(MUST NOT)。認証器はメモリ制限を超えた場合、エラーコード `CTAP2_ERR_REQUEST_TOO_LARGE` を返却することができます(MAY)。

もしマップのキーが解釈できない場合、それは無視される必要があります(MUST)。これは既存を壊さない新機能追加における追加フィールドによって有効になります。

ホストから認証器へのメッセージは"コマンド"と呼ばれ、認証器からホストへのメッセージは"リプライ"と呼ばれます。全ての値はビッグエンディアンエンコードされています。

認証器は受信したCBORメッセージが以上の規格に適合でない場合、エラーコード `CTAP2_ERR_INVALID_CBOR` を返却すべきです(SHOULD)。

