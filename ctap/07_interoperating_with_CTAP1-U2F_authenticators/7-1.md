# 7.1 U2Fコマンドのフレーム
U2Fプロトコルはリクエスト-レスポンス機構をベースにしており、リクエストがU2Fデバイスに送られると毎回レスポンスメッセージがU2Fデバイスからリクエスト元に対して送られます。

リクエストメッセージは低レイヤに送るためにフレーム化される必要があります。署名要求を例に取ると、フレーミングはFIDOクライアントが署名要求を送信していることを下位のトランスポート層に伝えるための方法であり、生のメッセージを送信します。また生のメッセージレスポンスやコマンド失敗時のエラーコードなどのメタ情報をどのように返すかについてもフレーミングで示されています。

U2Fの現バージョンにおいては、フレーミングはAPDUフォーマット拡張のISO7816-4-2005をベースに定義されています。これはセキュアエレメント周辺が実装されこのフォーマットを解釈することのできる、USBトランスポートを用いるデバイスによく適合します。これはBluetoothベースのデバイスでも同じことが言えるでしょう。それ以外の、ビルトインのu2fトークンを用いるモバイルデバイス上のTEEのようなトランスポート手法を用いるものについてはこのフレーミングは適さないため、異なるフレーミングが定義される必要があります。

## 7.7.1 U2Fリクエストメッセージフレーミング
生のリクエストメッセージはAPDUコマンドとしてフレームされます。

`CLA INS P1 P2 LC1 LC2 LC3`

CLA: トランスポートプロトコルが使用するために予約されています(該当する場合)。ホストアプリケーションはこのバイトを0にできます。

INS: U2Fコマンドコードであり、次章で定義します。

P1, P2: パラメータ1及び2であり、次章で定義します。

LC1-LC3: リクエストデータの長さをビッグエンディアンでエンコードしたもので、LC1はMSBでLC3はLSBといった形になります。

## 7.7.2 U2Fレスポンスメッセージフレーミング
生のレスポンスデータはAPDUコマンドとしてフレームされます。

`SW1 SW2`

SW1, SW2: ステータスを示すワードバイト1及び2であり、書式は以下に定義する通りの16ビットのステータスワードです。SW1はMSBでSW2はLSBです。

ISO7816-4で定義される以下のステータスワードはU2Fにおいて特別な意味を持ちます。

SW_NO_ERROR: エラーが発生することなく、コマンドが正常終了した
SW_CONDITIONS_NOT_SATISFIED: UPが必要なためにリクエストがリジェクトされた
SW_WRONG_DATA: キーハンドルが不正なためにrクエストがリジェクトされた

エラーに関するさらなる情報を提供する手段として、ベンダー指定のステータスコードなどを実装する手段もあります。FIDO U2Fクライアントにおいては上記のエラーコードのみがハンドル対象隣、それ以外の一般的なエラーやそれらのロギングについては任意です。
